<div class="flex flex-col gap-4">
  <app-tile [title]="'DATASOURCE.TITLE' | translate">
    <app-datasource-configuration
      [config]="form.getRawValue().datasource"
      (configChange)="onDatasourceChange($event)"
      (schemaChange)="onSchemaChange($event)">
    </app-datasource-configuration>
  </app-tile>

  <app-tile [title]="'COLUMNS.TITLE' | translate" *ngIf="columns.length > 0">
    <div class="flex flex-col gap-4">
      <div *ngFor="let column of columns; let i = index" class="bg-gray-800 border border-gray-700 rounded-lg shadow-lg">
        <!-- En-tête de la colonne -->
        <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-700" (click)="toggleColumnExpand(i)">
          <div class="flex items-center gap-4">
            <div class="flex gap-2">
              <button type="button" class="p-1 text-gray-400 hover:text-white disabled:text-gray-600" [disabled]="i === 0" (click)="moveColumn(i, 'up'); $event.stopPropagation()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
              <button type="button" class="p-1 text-gray-400 hover:text-white disabled:text-gray-600" [disabled]="i === columns.length - 1" (click)="moveColumn(i, 'down'); $event.stopPropagation()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <div>
              <span class="font-medium text-white">{{ column.key }}</span>
              <span class="ml-2 text-sm text-gray-400">
                ({{ column.type }})
                <svg *ngIf="column.entityMetadata?.isPrimaryKey" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd" />
                </svg>
                <svg *ngIf="column.entityMetadata?.isForeignKey" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
              </span>
            </div>
          </div>
          <div class="flex items-center gap-4">
            <!-- Boutons d'alignement -->
            <div class="flex rounded-md shadow-sm" role="group" (click)="$event.stopPropagation()">
              <button type="button" 
                class="px-2 py-1 text-gray-400 hover:text-white disabled:text-gray-600 border border-gray-700 first:rounded-l-md last:rounded-r-md"
                [class.bg-gray-700]="column.alignment === 'left'"
                (click)="handleColumnAlignmentChange(i, $event)"
                data-alignment="left">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
              <button type="button"
                class="px-2 py-1 text-gray-400 hover:text-white disabled:text-gray-600 border border-gray-700 -ml-px"
                [class.bg-gray-700]="column.alignment === 'center'"
                (click)="handleColumnAlignmentChange(i, $event)"
                data-alignment="center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3 5a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 5a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
              <button type="button"
                class="px-2 py-1 text-gray-400 hover:text-white disabled:text-gray-600 border border-gray-700 -ml-px"
                [class.bg-gray-700]="column.alignment === 'right'"
                (click)="handleColumnAlignmentChange(i, $event)"
                data-alignment="right">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm5 5a1 1 0 011-1h6a1 1 0 110 2H9a1 1 0 01-1-1zm0 5a1 1 0 011-1h6a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <!-- Toggle de visibilité -->
            <label class="relative inline-flex items-center cursor-pointer" (click)="$event.stopPropagation()">
              <input type="checkbox" [checked]="column.visible" (change)="handleColumnVisibilityChange(i, $event)" class="sr-only peer">
              <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
            <!-- Chevron -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" [class.transform]="expandedColumnIndex === i" [class.rotate-180]="expandedColumnIndex === i" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>

        <!-- Configuration détaillée de la colonne -->
        <div *ngIf="expandedColumnIndex === i" class="p-4 border-t border-gray-700 bg-gray-900">
          <div class="space-y-4">
            <!-- Labels -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">{{ 'COLUMNS.LABEL_EN' | translate }}</label>
                <input type="text" [value]="column.label['en']" (input)="handleColumnLabelChange(i, 'en', $event)"
                  class="w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">{{ 'COLUMNS.LABEL_FR' | translate }}</label>
                <input type="text" [value]="column.label['fr']" (input)="handleColumnLabelChange(i, 'fr', $event)"
                  class="w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
            </div>

            <!-- Décimales (pour les nombres) -->
            <div *ngIf="column.type === 'number'">
              <label class="block text-sm font-medium text-gray-300 mb-1">{{ 'COLUMNS.DECIMALS' | translate }}</label>
              <input type="number" [value]="column.decimals" (input)="handleColumnDecimalsChange(i, $event)"
                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
          </div>
        </div>
      </div>
    </div>
  </app-tile>
</div> 