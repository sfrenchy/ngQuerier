<div class="flex flex-col gap-4 p-4" *ngIf="config">
  <div class="flex flex-col">
    <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.TYPE' | translate }}</label>
    <select
      class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
      [(ngModel)]="config.type"
      (ngModelChange)="onTypeChange()">
      <option *ngFor="let type of datasourceTypes" [value]="type" class="bg-gray-700 text-white">
        {{ 'DATASOURCE.TYPES.' + type | translate }}
      </option>
    </select>
  </div>

  <!-- API Configuration -->
  <ng-container *ngIf="config.type === 'API'">
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.CONNECTION' | translate }}</label>
      <select
        class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
        [(ngModel)]="config.connection"
        (ngModelChange)="onConnectionChange($event)">
        <option [ngValue]="null" class="bg-gray-700 text-gray-400">{{ 'COMMON.SELECT_OPTION' | translate }}</option>
        <option *ngFor="let connection of connections" [ngValue]="connection" class="bg-gray-700 text-white">
          {{ connection.name }}
        </option>
      </select>
    </div>

    <div class="flex flex-col" *ngIf="config.connection">
      <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.CONTROLLER' | translate }}</label>
      <select
        class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
        [(ngModel)]="config.controller"
        (ngModelChange)="onControllerChange($event)">
        <option [ngValue]="null" class="bg-gray-700 text-gray-400">{{ 'COMMON.SELECT_OPTION' | translate }}</option>
        <option *ngFor="let controller of controllers" [ngValue]="controller" class="bg-gray-700 text-white">
          {{ controller.name }}
        </option>
      </select>
    </div>

    <!-- Stored Procedure Parameters -->
    <div class="flex flex-col gap-2" *ngIf="isStoredProcedure && config.controller?.parameterJsonSchema">
      <div class="text-sm font-medium text-gray-300">{{ 'DATASOURCE.PROCEDURE_PARAMETERS' | translate }}</div>
      <div class="flex flex-col gap-2" *ngFor="let param of getParametersList()">
        <div class="flex flex-col gap-2">
          <div class="flex items-center justify-between gap-2">
            <label class="text-sm font-medium text-gray-300">
              {{ param.name }}
              <span *ngIf="param.required" class="text-red-500 ml-1">*</span>
            </label>
            <div class="flex items-center gap-2">
              <input
                type="checkbox"
                class="w-4 h-4 text-primary-600 bg-gray-700 border-gray-600 rounded focus:ring-primary-500"
                [checked]="config.procedureParameters?.[param.name]?.userChangeAllowed"
                (change)="onUserChangeAllowedChange(param.name, $event)">
              <span class="text-sm text-gray-300">{{ 'DATASOURCE.USER_CHANGE_ALLOWED' | translate }}</span>
            </div>
          </div>

          <!-- Date Type Selector for Date Parameters -->
          <div class="flex flex-col gap-2" *ngIf="param.type === 'date' || param.type === 'datetime'">
            <select
              class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
              [ngModel]="config.procedureParameters?.[param.name]?.dateType"
              (ngModelChange)="onDateTypeChange(param.name, $event)">
              <option *ngFor="let type of dynamicDateTypes" [value]="type.key" class="bg-gray-700 text-white">
                {{ type.label | translate }}
              </option>
            </select>
          </div>

          <!-- Parameter Value Input -->
          <div [ngSwitch]="param.type">
            <!-- String Input -->
            <input *ngSwitchCase="'string'"
              type="text"
              class="bg-gray-700 text-sm rounded-lg border block w-full p-2.5 text-white"
              [class.border-gray-600]="!parameterErrors[param.name]"
              [class.border-red-500]="parameterErrors[param.name]"
              [class.focus:ring-primary-500]="!parameterErrors[param.name]"
              [class.focus:ring-red-500]="parameterErrors[param.name]"
              [class.focus:border-primary-500]="!parameterErrors[param.name]"
              [class.focus:border-red-500]="parameterErrors[param.name]"
              [ngModel]="config.procedureParameters?.[param.name]?.value"
              (ngModelChange)="onParameterValueChange(param.name, $event)">

            <!-- Number Input -->
            <input *ngSwitchCase="'number'"
              type="number"
              class="bg-gray-700 text-sm rounded-lg border block w-full p-2.5 text-white"
              [class.border-gray-600]="!parameterErrors[param.name]"
              [class.border-red-500]="parameterErrors[param.name]"
              [class.focus:ring-primary-500]="!parameterErrors[param.name]"
              [class.focus:ring-red-500]="parameterErrors[param.name]"
              [class.focus:border-primary-500]="!parameterErrors[param.name]"
              [class.focus:border-red-500]="parameterErrors[param.name]"
              [ngModel]="config.procedureParameters?.[param.name]?.value"
              (ngModelChange)="onParameterValueChange(param.name, $event)">

            <!-- Boolean Input -->
            <input *ngSwitchCase="'boolean'"
              type="checkbox"
              class="w-4 h-4 text-primary-600 bg-gray-700 border-gray-600 rounded focus:ring-primary-500"
              [ngModel]="config.procedureParameters?.[param.name]?.value"
              (ngModelChange)="onParameterValueChange(param.name, $event)">

            <!-- Date Input -->
            <input *ngSwitchCase="'date'"
              type="date"
              class="bg-gray-700 text-sm rounded-lg border block w-full p-2.5 text-white"
              [class.border-gray-600]="!parameterErrors[param.name]"
              [class.border-red-500]="parameterErrors[param.name]"
              [class.focus:ring-primary-500]="!parameterErrors[param.name]"
              [class.focus:ring-red-500]="parameterErrors[param.name]"
              [class.focus:border-primary-500]="!parameterErrors[param.name]"
              [class.focus:border-red-500]="parameterErrors[param.name]"
              [ngModel]="config.procedureParameters?.[param.name]?.value"
              (ngModelChange)="onParameterValueChange(param.name, $event)"
              [disabled]="config.procedureParameters?.[param.name]?.dateType !== 'specific'">

            <!-- DateTime Input -->
            <input *ngSwitchCase="'datetime'"
              type="datetime-local"
              class="bg-gray-700 text-sm rounded-lg border block w-full p-2.5 text-white"
              [class.border-gray-600]="!parameterErrors[param.name]"
              [class.border-red-500]="parameterErrors[param.name]"
              [class.focus:ring-primary-500]="!parameterErrors[param.name]"
              [class.focus:ring-red-500]="parameterErrors[param.name]"
              [class.focus:border-primary-500]="!parameterErrors[param.name]"
              [class.focus:border-red-500]="parameterErrors[param.name]"
              [ngModel]="config.procedureParameters?.[param.name]?.value"
              (ngModelChange)="onParameterValueChange(param.name, $event)"
              [disabled]="config.procedureParameters?.[param.name]?.dateType !== 'specific'">
          </div>

          <!-- Error Message -->
          <div *ngIf="parameterErrors[param.name]" class="text-sm text-red-500">
            {{ parameterErrors[param.name] }}
          </div>

          <!-- Parameter Description -->
          <div *ngIf="param.description" class="text-sm text-gray-400">
            {{ param.description }}
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- EntityFramework Configuration -->
  <ng-container *ngIf="config.type === 'EntityFramework'">
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.CONTEXT' | translate }}</label>
      <select
        class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
        [(ngModel)]="config.context"
        (ngModelChange)="onContextChange($event)">
        <option [ngValue]="null" class="bg-gray-700 text-gray-400">{{ 'COMMON.SELECT_OPTION' | translate }}</option>
        <option *ngFor="let context of contexts" [ngValue]="context" class="bg-gray-700 text-white">
          {{ context }}
        </option>
      </select>
    </div>

    <div class="flex flex-col" *ngIf="config.context">
      <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.ENTITY' | translate }}</label>
      <select
        class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
        [(ngModel)]="config.entity"
        (ngModelChange)="onEntityChange($event)">
        <option [ngValue]="null" class="bg-gray-700 text-gray-400">{{ 'COMMON.SELECT_OPTION' | translate }}</option>
        <option *ngFor="let entity of entities" [ngValue]="entity" class="bg-gray-700 text-white">
          {{ entity.name }}
        </option>
      </select>
    </div>
  </ng-container>

  <!-- SQL Query Configuration -->
  <ng-container *ngIf="config.type === 'SQLQuery'">
    <div class="flex flex-col">
      <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.QUERY' | translate }}</label>
      <select
        class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
        [(ngModel)]="config.query"
        (ngModelChange)="onQueryChange($event)">
        <option [ngValue]="null" class="bg-gray-700 text-gray-400">{{ 'COMMON.SELECT_OPTION' | translate }}</option>
        <option *ngFor="let query of queries" [ngValue]="query" class="bg-gray-700 text-white">
          {{ query.name }}
        </option>
      </select>
    </div>
  </ng-container>

  <!-- LocalDataTable Configuration -->
  <ng-container *ngIf="config.type === 'LocalDataTable'">
    <div class="flex flex-col gap-4">
      <!-- Sélection de la table source -->
      <div class="flex flex-col">
        <label class="text-sm font-medium text-gray-300 mb-1">{{ 'DATASOURCE.LOCAL_TABLE.SOURCE' | translate }}</label>
        <select
          class="bg-gray-700 text-sm rounded-lg border border-gray-600 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 cursor-pointer text-white"
          [ngModel]="config.localDataTable?.cardId || null"
          (ngModelChange)="onTableSelect($event)">
          <option [ngValue]="null">{{ 'DATASOURCE.SELECT_TABLE' | translate }}</option>
          <option *ngFor="let table of availableTables$ | async" [ngValue]="table.cardId">
            {{ getTableTitle(table) }}
          </option>
        </select>
      </div>

      <!-- Options de filtrage -->
      <div class="flex items-center gap-2" *ngIf="config.localDataTable">
        <input
          type="checkbox"
          class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2"
          [(ngModel)]="config.localDataTable.useFilteredData"
          (ngModelChange)="onConfigChange()">
        <label class="text-sm font-medium text-gray-300">
          {{ 'DATASOURCE.LOCAL_TABLE.USE_FILTERED_DATA' | translate }}
        </label>
      </div>

      <!-- Ne pas afficher la sélection de colonnes pour les graphiques -->
      <ng-container *ngIf="!isChartCard">
        <div *ngIf="sourceTableSchema" class="flex flex-col gap-2">
          <label class="text-sm font-medium text-gray-300">{{ 'DATASOURCE.LOCAL_TABLE.SELECT_COLUMNS' | translate }}</label>
          <div class="flex flex-wrap gap-2">
            <div *ngFor="let column of getSchemaColumns()" class="flex items-center gap-2">
              <input
                type="checkbox"
                class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2"
                [checked]="isColumnSelected(column.key)"
                (change)="toggleColumn(column.key)">
              <label class="text-sm text-gray-300">{{ column.title }}</label>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </ng-container>
</div>
